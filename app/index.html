<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mutt</title>
    <script src="https://unpkg.com/react@16.8/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800&amp;subset=cyrillic"
          rel="stylesheet">
    <link href="./index.css" rel="stylesheet">
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const {crawl, crawlAll, scripts} = require('../crawler.js')
  const {createAddWindow} = require('./addSubscription.js')
  const {ipcRenderer, remote} = require('electron')
  const classnames = require('classnames')
  const {default: TimeAgo} = require('react-timeago')
  const fs = require('fs')
  const path = require('path')
  const _ = require('lodash')

  const {app} = remote
  const userDataPath = app.getPath('userData')
  const dataPath = path.join(userDataPath, 'subscriptions.json')

  let initialState = {
    subscriptions: [],
  }

  try {
    initialState = JSON.parse(fs.readFileSync(dataPath).toString('utf8'))
    for (let s of initialState.subscriptions) {
      if (s.departDate) s.departDate = new Date(s.departDate)
      if (s.returnDate) s.returnDate = new Date(s.returnDate)
      if (s.timeAgo) s.timeAgo = new Date(s.timeAgo)
    }
  } catch (e) {
    // pass
  }

  class App extends React.Component {
    constructor(props) {
      super(props)
      this.state = initialState
    }

    render() {
      const {subscriptions} = this.state
      return (
        <div>
          <table className="table-container">
            <thead>
            <tr className="header">
              <th>&nbsp;</th>
              <th>Route</th>
              <th>Date</th>
              <th>Price found</th>
              <th>Agency</th>
              <th>Best price</th>
              <th>&nbsp;</th>
            </tr>
            </thead>
            <tbody>
            {subscriptions.map(s => <Subscription key={s.id} {...s}
                                                  onDelete={this.handleDelete}
                                                  onActivate={this.handleActivate}
                                                  onMute={this.handleNotify}
                                                  onPrice={this.handlePrice}
            />)}
            </tbody>
          </table>

          <img className="add-subscription" src="icons/add.svg" alt="" onClick={this.handleAdd}/>
        </div>
      )
    }

    handleAdd = () => {
      createAddWindow()
    }

    handleDelete = (event, id) => {
      this.setState({subscriptions: [...this.state.subscriptions.filter(s => s.id !== id)]})
    }

    handleActivate = (event, id) => {
      for (let s of this.state.subscriptions) {
        if (s.id === id) {
          s.active = !s.active
          if (s.active) {
            crawlAll(s, this.handlePrice)
          }
        }
      }
      this.setState({subscriptions: [...this.state.subscriptions]})
    }

    handleNotify = (event, id) => {
      for (let s of this.state.subscriptions) {
        if (s.id === id) {
          s.notify = !s.notify
        }
      }
      this.setState({subscriptions: [...this.state.subscriptions]})
    }

    handleCreated = (subscription) => {
      crawlAll(subscription, this.handlePrice)
    }

    handlePrice = ({script, price, id}) => {
      const s = this.get(id)
      if (s) {
        s.timeAgo = new Date()
        s.prices[script] = price
        this.save()
      }
    }

    get = (id) => {
      let subscription
      for (let s of this.state.subscriptions) {
        if (s.id === id) {
          subscription = s
        }
      }
      return subscription
    }

    save = () => {
      this.setState({subscriptions: [...this.state.subscriptions]})
    }

    componentDidMount() {
      ipcRenderer.on('add_subscription', (event, form) => {
        const s = {}
        for (const {name, value} of form) {
          s[name] = value
        }

        let max = 0
        for (let s of this.state.subscriptions) {
          if (s.id > max) {
            max = s.id
          }
        }

        s.id = max + 1
        s.active = true
        s.departDate = new Date(s.departDate)
        s.returnDate = new Date(s.returnDate)
        s.notify = true
        s.prices = {}

        this.setState({subscriptions: [...this.state.subscriptions, s]})

        this.handleCreated(s)
      })

      setInterval(() => {
        fs.writeFileSync(dataPath, JSON.stringify(this.state, null, 2))
      }, 2000)
    }
  }

  class Subscription extends React.Component {
    state = {
      expanded: false
    }

    render() {
      const {
        id,
        origin, destination, departDate, returnDate,
        active, timeAgo, prices, notify,
        onDelete, onActivate, onMute, onPrice,
      } = this.props

      const {expanded} = this.state

      let agency, price
      for (let [a, p] of Object.entries(prices)) {
        if (!p) {
          continue
        }
        if (typeof price === 'undefined' || price > p) {
          price = p
          agency = a
        }
      }

      return (
        <tr className={classnames('flex-table row', {'inactive': !active})} onContextMenu={this.handleMenu}>
          <td>
            {!active
              ? <img src="icons/play.svg" alt="" className="play-pause" onClick={e => onActivate(e, id)}/>
              : <img src="icons/pause.svg" alt="" className="play-pause" onClick={e => onActivate(e, id)}/>}
          </td>
          <td>
            <div className="route">
              <div className="origin">{origin.toUpperCase()}</div>
              <img src="./icons/planes.svg" alt=""/>
              <div className="destination">{destination.toUpperCase()}</div>
            </div>
          </td>

          <td className="dates">
            <div>{getLongMonthName(departDate)} {departDate.getDate()}, {departDate.getFullYear()}</div>
            <div>{getLongMonthName(departDate)} {returnDate.getDate()}, {returnDate.getFullYear()}</div>
          </td>

          <td className="price-found">
            {timeAgo && <TimeAgo date={timeAgo.toUTCString()}/>}
          </td>

          <td>
            <div className="agency">{agency}</div>
            {expanded
              ?
              <div className="agency-more" onClick={this.handleMore}>
                Collapse <img src="icons/collapse.svg" alt=""/>
              </div>
              :
              <div className="agency-more" onClick={this.handleMore}>
                Check other deals <img src="icons/more.svg" alt=""/>
              </div>
            }

            {expanded && (
              <div className="others">
                {_.sortBy(Object.entries(prices), 1).map(([a, p]) => {
                  if (a === agency) {
                    return null
                  }
                  return (
                    <div>
                      <a key={a} className="other-agency">{a}</a>
                      {p
                        ? <a key={a} className="other-price">${p} <img src="icons/external.svg" alt=""/></a>
                        : <img className="other-price-error" src="icons/error.svg" alt=""/>}
                    </div>
                  )
                })}
              </div>
            )}
          </td>

          <td>
            <div className="best-price">
              {notify
                ? <img src="icons/notify.svg" alt="" onClick={e => onMute(e, id)}/>
                : <img src="icons/no-notify.svg" alt="" onClick={e => onMute(e, id)}/>}
              <div className="value">${price}</div>
            </div>
          </td>

          <td>
            <div className="controls">
              <div className="btn">View details</div>
              <img src="icons/delete.svg" alt="" onClick={e => onDelete(e, id)}/>
            </div>
          </td>
        </tr>
      )
    }

    handleMore = (event) => {
      this.setState({expanded: !this.state.expanded})
    }

    handleMenu = (event) => {
      const {Menu, MenuItem} = remote

      const menu = new Menu()
      for (let script of scripts) {
        menu.append(new MenuItem({
          label: `Inspect ${script}`,
          click: () => crawl(this.props, script, this.props.onPrice, {headless: false, close: false}),
        }))
      }

      event.preventDefault()
      menu.popup({window: remote.getCurrentWindow()})
    }
  }

  function getLongMonthName(date) {
    const mlist = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
    return mlist[date.getMonth()]
  }

  // Start app
  const domContainer = document.querySelector('#root')
  ReactDOM.render(
    <App/>
    , domContainer)
</script>
</body>
</html>
